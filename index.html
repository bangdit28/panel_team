<!DOCTYPE html>
<html lang="id">
<head>
    <!-- üîí SECURITY CHECK (SATPAM) üîí -->
    <script>
        if (localStorage.getItem('TASIK_TOKEN') !== 'VALID_ACCESS_164') {
            window.location.href = 'login.html';
        }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PANEL TASIK V164 (DASHBOARD)</title>
    
    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Orbitron&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS RAPI & TERBACA --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            background: #0f172a; color: #fff; font-family: 'Roboto', sans-serif; 
            margin: 0; padding: 0; padding-bottom: 80px;
            min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }

        /* HEADER */
        .top-header {
            background: #1e293b; padding: 12px 15px; 
            border-bottom: 1px solid #334155; display: flex; 
            justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .app-title { font-size: 16px; font-weight: 800; color: #f43f5e; letter-spacing: 1px; }
        .user-info-header { display: flex; align-items: center; gap: 10px; }
        .header-name { font-size: 12px; font-weight: bold; color: #fff; text-transform: uppercase; }

        /* NAVIGASI BAWAH */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1e293b; border-top: 1px solid #334155;
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 15px; z-index: 9999; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #64748b; font-size: 9px; cursor: pointer; transition: 0.2s; width: 18%;
        }
        .nav-item svg { width: 22px; height: 22px; fill: currentColor; margin-bottom: 4px; }
        .nav-item.active { color: #f43f5e; font-weight: bold; }
        .nav-item.active svg { fill: #f43f5e; transform: translateY(-3px); }
        
        /* TOMBOL WALLET TENGAH */
        .nav-item.wallet-nav { margin-top: -35px; }
        .nav-item.wallet-nav .icon-circle {
            width: 55px; height: 55px; background: #f43f5e; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(244, 63, 94, 0.5); border: 4px solid #0f172a;
        }
        .nav-item.wallet-nav svg { fill: #fff; width: 26px; height: 26px; margin: 0; }

        /* HALAMAN */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* KOTAK KONTEN */
        .box { 
            width: 100%; background: #1e293b; 
            padding: 15px; border-radius: 12px; border: 1px solid #334155; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            margin-bottom: 15px;
        }

        /* --- UI FARMING (NOMOR & OTP) --- */
        .display-num { 
            font-size: 26px; font-family: monospace; background: #000; 
            padding: 15px; border-radius: 8px; border: 2px dashed #f43f5e; 
            margin: 10px 0; text-align: center; color: #fff; cursor: pointer; letter-spacing: 1px;
        }
        .otp-area { 
            background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid #334155; 
            padding: 15px; text-align: center; margin-bottom: 15px; 
            min-height: 90px; display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .otp-code { font-size: 48px; font-weight: 800; color: #4ade80; letter-spacing: 5px; cursor: pointer; }
        .waiting { font-size: 11px; color: #fbbf24; animation: blink 1.5s infinite; font-weight: bold; }

        /* BUTTONS */
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px; text-transform: uppercase; margin-top: 5px; }
        .btn-start { background: #f43f5e; color: #fff; }
        .btn-bad { background: #ef4444; color: #fff; }
        .btn-next { background: #10b981; color: #fff; }
        .btn-stop { background: transparent; border: 1px solid #475569; color: #94a3b8; }
        select, input { width: 100%; padding: 12px; background: #0f172a; color: #fff; border: 1px solid #334155; border-radius: 8px; margin-bottom: 10px; font-size: 14px; }

        /* HISTORY FEED */
        .g-item { background: #1e293b; border-bottom: 1px solid #334155; padding: 12px; font-size: 11px; }
        .x-green { color: #4ade80; font-weight: bold; font-family: monospace; background: rgba(74, 222, 128, 0.1); padding: 2px 4px; border-radius: 3px; }
        
        /* WALLET */
        .wallet-card { background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%); border-radius: 15px; padding: 25px; color: #fff; text-align: center; margin-bottom: 20px; }
        .wallet-balance { font-size: 36px; font-weight: bold; margin: 10px 0; font-family: 'Orbitron', sans-serif; }

        /* TOAST */
        #toast { visibility: hidden; min-width: 120px; background-color: #4ade80; color: #000; text-align: center; border-radius: 50px; padding: 10px 20px; position: fixed; z-index: 10000; left: 50%; bottom: 100px; transform: translateX(-50%); font-weight: bold; opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }
        
        .hidden { display: none !important; }
        @keyframes popIn { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="toast">Disalin!</div>

    <!-- HEADER -->
    <div class="top-header">
        <div class="app-title">PANEL TASIK V164</div>
        <div class="user-info-header">
            <div class="header-name" id="displayUsername">...</div>
        </div>
    </div>

    <!-- 1. HALAMAN HOME -->
    <div id="pageHome" class="page active">
        <!-- MENU -->
        <div id="boxMenu" class="box">
            <h3 style="margin-top:0; color:#aaa; font-size:11px;">PILIH NEGARA</h3>
            <select id="countryPick"><option>Memuat Server...</option></select>
            <button class="btn-start" onclick="startFarming()">AMBIL NOMOR</button>
        </div>

        <!-- FARMING (HIDDEN DEFAULT) -->
        <div id="boxFarming" class="hidden">
            <div class="box">
                <div style="font-size:10px; color:#aaa; margin-bottom:5px; text-align:center;">NOMOR AKTIF</div>
                <div class="display-num" onclick="copyText(document.getElementById('txtNum').innerText)">
                    <span id="txtNum">...</span>
                </div>
                <div class="otp-area">
                    <div id="statusWait" class="waiting">üì° MENUNGGU SMS...</div>
                    <div id="myOTP" class="otp-code hidden" onclick="copyText(this.innerText)">---</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-bad" onclick="actionBad()">üîÑ GANTI</button>
                    <button class="btn-next" onclick="actionNext()">‚úÖ LANJUT</button>
                </div>
                <button class="btn-stop" onclick="stopFarming()">‚èπÔ∏è MINIMIZE</button>
            </div>
        </div>

        <!-- HISTORY PRIBADI -->
        <div class="box" style="margin-top:20px;">
            <div style="font-size:11px; color:#f43f5e; font-weight:bold; border-bottom:1px solid #333; padding-bottom:8px; margin-bottom:10px;">üë§ RIWAYAT SAYA</div>
            <div id="personalHistory"></div>
        </div>
    </div>

    <!-- 2. HALAMAN HISTORY (GLOBAL) -->
    <div id="pageHistory" class="page">
        <div class="box">
            <div style="font-size:11px; color:#f43f5e; font-weight:bold; border-bottom:1px solid #333; padding-bottom:8px; margin-bottom:10px;">üî¥ GLOBAL LIVE FEED</div>
            <div id="globalFeed" style="min-height:200px;">Loading...</div>
        </div>
    </div>

    <!-- 3. HALAMAN WALLET -->
    <div id="pageWallet" class="page">
        <div class="wallet-card">
            <div style="font-size:10px; opacity:0.8;">SALDO KAMU</div>
            <div class="wallet-balance" id="walletBalance">Rp 0</div>
            <div style="font-size:9px;">Per OTP: Rp 20 - Rp 50</div>
        </div>
        <div class="box">
            <h3 style="margin-top:0; color:#aaa; font-size:12px;">TARIK DANA</h3>
            <input type="number" id="wdNum" placeholder="Nomor DANA">
            <input type="number" id="wdAmount" placeholder="Jumlah (Min 5000)">
            <button class="btn-save" onclick="reqWithdraw()">KIRIM PERMINTAAN</button>
        </div>
    </div>

    <!-- 4. HALAMAN CHAT -->
    <div id="pageChat" class="page">
        <div class="box" style="height:60vh; display:flex; align-items:center; justify-content:center;">
            <p style="color:#666;">Fitur Chat Aktif</p>
        </div>
    </div>

    <!-- 5. HALAMAN PROFIL -->
    <div id="pageProfil" class="page">
        <div class="box" style="text-align:center; padding:30px;">
            <h2 id="profileName">User</h2>
            <p style="color:#aaa; font-size:12px;">Member Panel Tasik</p>
            <button class="btn-bad" onclick="doLogout()">LOGOUT</button>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('pageHome', this)"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></div>
        <div class="nav-item" onclick="switchPage('pageHistory', this)"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>History</span></div>
        <div class="nav-item wallet-nav" onclick="switchPage('pageWallet', this)"><div class="icon-circle"><svg viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .89-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></div><span>Wallet</span></div>
        <div class="nav-item" onclick="switchPage('pageChat', this)"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg><span>Chat</span></div>
        <div class="nav-item" onclick="switchPage('pageProfil', this)"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>Profil</span></div>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDQ6jBWPxaItR4LntBwdviM5BAGxhd2N7Q",
            authDomain: "vipotpsystem.firebaseapp.com",
            databaseURL: "https://vipotpsystem-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "vipotpsystem",
            storageBucket: "vipotpsystem.firebasestorage.app",
            messagingSenderId: "1041472357696",
            appId: "1:1041472357696:web:d3070f47a3c263657da6a5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // USER INFO
        const currentUser = localStorage.getItem('TASIK_USER');
        document.getElementById('displayUsername').innerText = currentUser;
        document.getElementById('profileName').innerText = currentUser;

        // --- NAVIGATION ---
        window.switchPage = (pageId, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        // --- LOGOUT ---
        window.doLogout = () => {
            if(confirm("Keluar dari akun?")) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // --- 1. LOAD COUNTRIES ---
        db.ref('settings/countries').on('value', snap => {
            const d = snap.val();
            const sel = document.getElementById('countryPick');
            sel.innerHTML = "";
            if(d) {
                Object.keys(d).forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k; opt.innerText = d[k];
                    sel.appendChild(opt);
                });
            } else {
                sel.innerHTML = "<option>Error Koneksi</option>";
            }
        });

        // --- 2. WALLET SYSTEM ---
        let balance = 0;
        db.ref('accounts/' + currentUser + '/balance').on('value', snap => {
            balance = snap.val() || 0;
            document.getElementById('walletBalance').innerText = "Rp " + balance.toLocaleString();
        });

        window.reqWithdraw = () => {
            const num = document.getElementById('wdNum').value;
            const amt = parseInt(document.getElementById('wdAmount').value);
            if(!num || !amt) return alert("Lengkapi data!");
            if(amt > balance) return alert("Saldo kurang!");
            
            db.ref('withdrawals').push({
                user: currentUser,
                amount: amt,
                dana: num,
                status: 'PENDING',
                time: Date.now()
            });
            // Kurangi saldo lokal sementara (Optimistic UI)
            db.ref('accounts/' + currentUser).update({ balance: balance - amt });
            alert("Permintaan dikirim!");
        }

        // --- 3. FARMING LOGIC ---
        let currentNum = null;
        let listenerRef = null;
        
        window.startFarming = () => {
            const country = document.getElementById('countryPick').value;
            // Simplified Logic for Demo: Find Available
            db.ref('stock').once('value', snap => {
                const data = snap.val();
                let found = null;
                if(data) {
                    Object.keys(data).forEach(k => {
                        if(data[k].status === 'AVAILABLE' && data[k].country === country && !found) {
                            found = k;
                        }
                    });
                }

                if(found) {
                    db.ref('stock/'+found).update({ status: 'TAKEN', op_name: currentUser });
                    currentNum = found;
                    activateFarmingUI(found);
                } else {
                    alert("Stok Habis!");
                }
            });
        }

        function activateFarmingUI(num) {
            document.getElementById('areaMenu').classList.add('hidden');
            document.getElementById('areaFarming').classList.remove('hidden');
            document.getElementById('txtNum').innerText = "+" + num;
            
            // Listener OTP
            if(listenerRef) listenerRef.off();
            listenerRef = db.ref('stock/'+num);
            listenerRef.on('value', snap => {
                const d = snap.val();
                if(d && d.otp) {
                    document.getElementById('statusWait').classList.add('hidden');
                    document.getElementById('myOTP').classList.remove('hidden');
                    document.getElementById('myOTP').innerText = d.otp;
                    
                    // Auto Reward
                    if(d.otp.length > 3) {
                         const reward = Math.floor(Math.random() * (50 - 20) + 20);
                         db.ref('accounts/' + currentUser).update({ balance: balance + reward });
                    }
                }
            });
        }

        window.actionBad = () => {
            if(currentNum) db.ref('stock/'+currentNum).update({ status: 'BAD' });
            window.startFarming(); // Cari lagi
        }
        
        window.actionNext = () => {
            if(currentNum) db.ref('stock/'+currentNum).update({ status: 'DONE' });
            window.startFarming(); // Cari lagi
        }

        window.stopFarming = () => {
            if(listenerRef) listenerRef.off();
            currentNum = null;
            document.getElementById('areaFarming').classList.add('hidden');
            document.getElementById('areaMenu').classList.remove('hidden');
        }

        // --- GLOBAL FEED ---
        db.ref('stock').orderByChild('last_update').limitToLast(20).on('child_added', snap => {
            const d = snap.val();
            if(d.otp) {
                const div = document.createElement('div');
                div.className = 'g-item';
                div.innerHTML = `<span style="color:#f43f5e;font-weight:bold">${d.op_name||'User'}</span>: FB-<span class="x-green">XXXXX</span> code`;
                const feed = document.getElementById('globalFeed');
                if(feed.innerText.includes('Load')) feed.innerHTML = "";
                feed.insertBefore(div, feed.firstChild);
            }
        });

        // --- UTILS ---
        window.copyText = (text) => {
            navigator.clipboard.writeText(text);
            const t = document.getElementById('toast');
            t.className = 'show';
            setTimeout(() => t.className = t.className.replace("show", ""), 3000);
        }
    </script>
</body>
</html>
