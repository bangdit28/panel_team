
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER ADMIN V125 (UI FIX)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .box { width: 100%; max-width: 800px; border: 1px solid #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; background: #111; }
        h2 { margin-top: 0; color: #00ff88; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* TABS */
        .tabs-header { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 8px; cursor: pointer; flex: 1; font-weight: bold; font-size: 11px; min-width: 80px; }
        .tab-btn.active { background: #00ff88; color: #000; border-color: #00ff88; }
        .tab-btn.money-tab.active { background: #f43f5e; color: #fff; border-color: #f43f5e; }
        .tab-btn.sys-tab.active { background: #eab308; color: #000; border-color: #eab308; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* üî• GRID DASHBOARD 4 KOTAK (RESTORED) üî• */
        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #1a1a1a; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #444; display: flex; flex-direction: column; justify-content: center; min-height: 100px; }
        .stat-num { font-size: 32px; font-weight: bold; display: block; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: #aaa; font-weight: bold; letter-spacing: 1px; }

        /* LISTS */
        .list-container { max-height: 400px; overflow-y: auto; padding-right: 5px; border: 1px solid #222; background: #0a0a0a; margin-top: 10px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 10px; margin-bottom: 5px; border-radius: 5px; border-left: 3px solid #555; }
        .wd-card { border-left: 3px solid #f43f5e !important; background: #1f1212 !important; }
        .wd-info { display: flex; flex-direction: column; gap: 2px; font-size: 12px; }
        
        /* INPUTS & BUTTONS */
        input, select { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #555; box-sizing: border-box; margin-bottom: 5px; }
        button.action-btn { border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-size: 10px; font-weight: bold; color: #fff; transition: 0.2s; }
        button.action-btn:hover { opacity: 0.8; transform: scale(1.05); }
        .bg-red { background: #d32f2f; } .bg-green { background: #00e676; color:#000; } .bg-blue { background: #2979ff; }
        
        /* SYSTEM TAB */
        .sys-group { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .switch-btn { padding: 10px; width: 100%; border: none; font-weight: bold; cursor: pointer; }
        .sw-on { background: #00e676; color: #000; } .sw-off { background: #d32f2f; color: #fff; }
    </style>
</head>
<body>

    <div class="box">
        <h2>‚ö° V125 ADMIN (DASHBOARD FIX)</h2>

        <div class="tabs-header">
            <button class="tab-btn active" onclick="switchTab('dash')">üìä DASHBOARD</button>
            <button class="tab-btn money-tab" onclick="switchTab('money')">üí∞ KEUANGAN</button>
            <button class="tab-btn sys-tab" onclick="switchTab('system')">‚öôÔ∏è SYSTEM</button>
            <button class="tab-btn" onclick="switchTab('recycle')">‚ôªÔ∏è RECYCLE</button>
            <button class="tab-btn" onclick="switchTab('country')">üåç NEGARA</button>
            <button class="tab-btn" onclick="switchTab('upload')">üõ†Ô∏è TOOLS</button>
        </div>

        <!-- DASHBOARD (TAMPILAN DIKEMBALIKAN KE 4 KOTAK) -->
        <div id="dash" class="tab-content active">
            <div class="grid-stats">
                <!-- 1. AVAILABLE -->
                <div class="stat-card" style="border-color: #00e676;">
                    <span id="countAvail" class="stat-num" style="color:#00e676">0</span>
                    <span class="stat-label">AVAILABLE (STOK)</span>
                </div>
                <!-- 2. ACTIVE -->
                <div class="stat-card" style="border-color: #2979ff;">
                    <span id="countActive" class="stat-num" style="color:#2979ff">0</span>
                    <span class="stat-label">ACTIVE (TAKEN)</span>
                </div>
                <!-- 3. RECYCLE BIN -->
                <div class="stat-card" style="border-color: #ff9800;">
                    <span id="countRecycle" class="stat-num" style="color:#ff9800">0</span>
                    <span class="stat-label">‚ôªÔ∏è RECYCLE BIN</span>
                </div>
                <!-- 4. TRASH / DONE -->
                <div class="stat-card" style="border-color: #ff1744;">
                    <span id="countTrash" class="stat-num" style="color:#ff1744">0</span>
                    <span class="stat-label">SELESAI / BAD</span>
                </div>
            </div>
            
            <button onclick="clearZombies()" class="action-btn bg-blue" style="width:100%; padding:15px; margin-bottom:15px;">üßπ LEPASKAN NOMOR STUCK ( > 2 MENIT)</button>

            <!-- NOTIF -->
            <div style="background:rgba(255, 215, 0, 0.05); border:1px dashed #ffd700; padding:15px; border-radius:8px;">
                <label style="color:#ffd700; font-size:11px;">üì¢ RUNNING TEXT:</label>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="text" id="notifMsg" placeholder="Isi pesan...">
                    <button onclick="sendNotif()" class="action-btn" style="background:#ffd700; color:#000;">KIRIM</button>
                    <button onclick="clearNotif()" class="action-btn bg-red">HAPUS</button>
                </div>
            </div>
        </div>

        <!-- üí∞ KEUANGAN -->
        <div id="money" class="tab-content">
            <div class="list-container" id="wdListContainer">Loading...</div>
        </div>

        <!-- ‚öôÔ∏è SYSTEM SETTINGS -->
        <div id="system" class="tab-content">
            <div class="sys-group">
                <div style="font-size:11px; color:#aaa; margin-bottom:5px;">HARGA REWARD PER OTP (Rp):</div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="rewMin" placeholder="Min" value="20">
                    <input type="number" id="rewMax" placeholder="Max" value="50">
                </div>
                <button onclick="saveRewardConfig()" class="action-btn bg-green" style="width:100%; margin-top:5px;">SIMPAN HARGA</button>
            </div>
            <div class="sys-group">
                <div style="font-size:11px; color:#aaa; margin-bottom:5px;">STATUS FITUR WALLET:</div>
                <div style="display:flex; gap:10px;">
                    <button onclick="setWalletStatus('ON')" class="switch-btn sw-on">BUKA (ON)</button>
                    <button onclick="setWalletStatus('OFF')" class="switch-btn sw-off">TUTUP (MAINTENANCE)</button>
                </div>
                <div id="walletStatusText" style="margin-top:5px; font-size:10px; text-align:center;">...</div>
            </div>
        </div>

        <!-- ‚ôªÔ∏è RECYCLE -->
        <div id="recycle" class="tab-content">
            <div style="margin-bottom:10px;"><button onclick="restoreAllRecycle()" class="action-btn bg-green">RESTORE ALL</button> <button onclick="flushRecycle()" class="action-btn bg-red">HAPUS ALL</button></div>
            <div class="list-container" id="recycleListContainer"></div>
        </div>

        <!-- üåç NEGARA -->
        <div id="country" class="tab-content">
            <div style="display:flex; gap:5px;"><input id="cCode" placeholder="ID"><input id="cName" placeholder="INDONESIA"><button onclick="saveCountry()" class="action-btn bg-green">SAVE</button></div>
            <button onclick="clearAllCountries()" class="action-btn bg-red" style="margin-top:5px;">RESET NEGARA</button>
            <div class="list-container" id="countryListDisplay"></div>
        </div>

        <!-- üõ†Ô∏è TOOLS -->
        <div id="upload" class="tab-content">
            <select id="countrySelectUpload"></select>
            <textarea id="numList" placeholder="Paste nomor..." style="height:80px;"></textarea>
            <button onclick="uploadStockSafe()" class="action-btn bg-green" style="width:100%;">UPLOAD</button>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="clearTrash()" class="action-btn bg-red" style="flex:1;">CLEAR HISTORY</button>
                <button onclick="clearAll()" class="action-btn bg-red" style="flex:1;">RESET ALL</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDQ6jBWPxaItR4LntBwdviM5BAGxhd2N7Q",
            authDomain: "vipotpsystem.firebaseapp.com",
            databaseURL: "https://vipotpsystem-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "vipotpsystem",
            storageBucket: "vipotpsystem.firebasestorage.app",
            messagingSenderId: "1041472357696",
            appId: "1:1041472357696:web:d3070f47a3c263657da6a5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- DASHBOARD CORE ---
        let lastUpdate = 0;
        db.ref('stock').on('value', snap => {
            if (Date.now() - lastUpdate > 1000) { renderDashboard(snap.val()); lastUpdate = Date.now(); }
        });

        function renderDashboard(data) {
            let avail=0, active=0, recycle=0, trash=0;
            let recHTML = "";

            if(data) Object.keys(data).forEach(k => {
                const i = data[k];
                if(i.status==='AVAILABLE') avail++;
                else if(i.status==='TAKEN') active++;
                else if(i.status==='RECYCLE') { // Explicit Recycle Bin
                    recycle++;
                    recHTML += `<div class="list-item" style="border-left-color:#ff9800"><div class="item-info"><span style="color:#ff9800">${i.country}</span> ${i.number}<br><span style="color:#666;font-size:10px">${i.op_name||'-'}</span></div><div><button class="action-btn bg-green" onclick="restoreOne('${k}')">R</button> <button class="action-btn" onclick="navigator.clipboard.writeText('${i.number}')">C</button></div></div>`;
                }
                else if(i.status==='DONE' || i.status==='BAD') trash++; // Group Done/Bad as Trash
            });

            document.getElementById('countAvail').innerText = avail;
            document.getElementById('countActive').innerText = active;
            document.getElementById('countRecycle').innerText = recycle;
            document.getElementById('countTrash').innerText = trash;
            document.getElementById('recycleListContainer').innerHTML = recHTML || "Kosong";
        }

        // --- SYSTEM CONFIG ---
        db.ref('settings/config').on('value', snap => {
            const c = snap.val() || { reward_min: 20, reward_max: 50, wallet_status: 'ON' };
            document.getElementById('rewMin').value = c.reward_min;
            document.getElementById('rewMax').value = c.reward_max;
            document.getElementById('walletStatusText').innerText = "Status: " + c.wallet_status;
        });
        window.saveRewardConfig = () => db.ref('settings/config').update({ reward_min: parseInt(document.getElementById('rewMin').value), reward_max: parseInt(document.getElementById('rewMax').value) });
        window.setWalletStatus = (s) => db.ref('settings/config').update({ wallet_status: s });

        // --- WD LIST ---
        db.ref('withdrawals').on('value', snap => {
            const d = snap.val(); const c = document.getElementById('wdListContainer'); c.innerHTML="";
            if(d) Object.keys(d).forEach(k => {
                const i = d[k];
                if(i.status === 'PENDING') {
                    c.innerHTML += `<div class="list-item wd-card"><div class="wd-info"><span style="color:#f43f5e;font-weight:bold;">${i.user}</span><span>Rp ${i.amount} -> ${i.dana}</span></div><div><button class="action-btn bg-green" onclick="accWD('${k}')">ACC</button> <button class="action-btn bg-red" onclick="decWD('${k}','${i.user}',${i.amount})">TOLAK</button></div></div>`;
                }
            });
            if(c.innerHTML==="") c.innerHTML="<div style='text-align:center;padding:10px;'>Tidak ada request.</div>";
        });
        window.accWD = (k) => { if(confirm("ACC?")) db.ref('withdrawals/'+k).update({status:'SUCCESS'}); }
        window.decWD = (k,u,a) => { if(confirm("Tolak & Refund?")) { db.ref('withdrawals/'+k).update({status:'REJECTED'}); db.ref('users/'+u+'/balance').once('value',s=>db.ref('users/'+u).update({balance:(s.val()||0)+a})); } }

        // --- OTHERS ---
        db.ref('settings/countries').on('value', s => {
            const d=s.val(); const l=document.getElementById('countryListDisplay'); const u=document.getElementById('countrySelectUpload');
            l.innerHTML=""; u.innerHTML="";
            if(d) Object.keys(d).forEach(k => {
                l.innerHTML+=`<div class="list-item"><span>${d[k]}</span><button class="action-btn bg-red" onclick="delCountry('${k}')">X</button></div>`;
                const o=document.createElement('option'); o.value=k; o.innerText=d[k]; u.appendChild(o);
            });
        });
        window.saveCountry=()=>{const c=document.getElementById('cCode').value; const n=document.getElementById('cName').value; if(c&&n)db.ref('settings/countries/'+c).set(n);}
        window.delCountry=(k)=>{if(confirm("Del?"))db.ref('settings/countries/'+k).remove();}
        window.clearAllCountries=()=>{if(confirm("Reset?"))db.ref('settings/countries').remove();}
        window.uploadStockSafe=()=>{
            const raw=document.getElementById('numList').value; const c=document.getElementById('countrySelectUpload').value;
            if(!c)return alert("Pilih Negara!");
            const lines=raw.split(/\n/); const ts=Date.now();
            db.ref('stock').once('value', snap=>{
                const ex=snap.val()||{}; let u={};
                lines.forEach(l=>{ let n=l.replace(/\D/g,''); if(n.length>6 && !ex[n]) u[n]={number:n, country:c, status:'AVAILABLE', range_name:"MANUAL", timestamp:ts, otp:""}; });
                db.ref('stock').update(u, e=>{ if(!e) {alert("Done"); document.getElementById('numList').value="";} });
            });
        }
        window.switchTab=(id)=>{ document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }
        window.restoreOne=(k)=>db.ref('stock/'+k).update({status:'AVAILABLE',owner:null,op_name:null,otp:null});
        window.restoreAllRecycle=()=>{ if(confirm("All?")) db.ref('stock').once('value',s=>{ const d=s.val(); let u={}; Object.keys(d).forEach(k=>{ if(d[k].status==='RECYCLE') u[k+'/status']='AVAILABLE'; }); db.ref('stock').update(u); }); }
        window.flushRecycle=()=>{ if(confirm("Flush?")) db.ref('stock').once('value',s=>{ const d=s.val(); let u={}; Object.keys(d).forEach(k=>{ if(d[k].status==='RECYCLE') u[k]=null; }); db.ref('stock').update(u); }); }
        window.clearZombies=()=>{ db.ref('stock').once('value',s=>{ const d=s.val(); let u={}; const now=Date.now(); Object.keys(d).forEach(k=>{ if(d[k].status==='TAKEN' && (now-(d[k].timestamp||0)>120000)) { u[k+'/status']='RECYCLE'; u[k+'/op_name']='(Timeout)'; } }); db.ref('stock').update(u); }); }
        window.clearTrash=()=>{ if(confirm("Clean History?")) db.ref('stock').once('value',s=>{ const d=s.val(); let u={}; Object.keys(d).forEach(k=>{ if(d[k].status==='DONE'||d[k].status==='BAD')u[k]=null; }); db.ref('stock').update(u); }); }
        window.clearAll=()=>{ if(confirm("RESET ALL?")) db.ref('stock').remove(); }
        window.sendNotif = () => db.ref('system/notification').set(document.getElementById('notifMsg').value);
        window.clearNotif = () => db.ref('system/notification').remove();
    </script>
</body>
</html>
