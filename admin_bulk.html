<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN V117 COMMANDER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .box { width: 100%; max-width: 700px; border: 1px solid #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; background: #111; }
        h2 { margin-top: 0; color: #00ff88; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* LIST RANGE */
        .range-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #1a1a1a; padding: 10px; margin-bottom: 5px; border-radius: 5px; border-left: 4px solid #2979ff; 
        }
        .range-info { font-size: 12px; }
        .range-name { color: #fff; font-weight: bold; font-size: 14px; }
        .range-country { color: #aaa; font-size: 11px; margin-left: 5px; background: #222; padding: 2px 5px; border-radius: 3px; }
        
        .range-stats { color: #00ff88; font-weight: bold; }
        .btn-del { background: #d32f2f; color: #fff; border: none; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .btn-del:hover { background: #ff5252; }

        .loading { text-align:center; padding:20px; color:#aaa; }
    </style>
</head>
<body>

    <div class="box">
        <h2>âš¡ V117 RANGE COMMANDER</h2>
        <div style="font-size:11px; color:#aaa; margin-bottom:15px; text-align:center;">
            Monitor stok berdasarkan Range IvaSMS. Hapus range yang macet/error di sini.
        </div>

        <div id="rangeListContainer">
            <div class="loading">Memuat Data Stok...</div>
        </div>
    </div>

    <script>
        // ðŸ”¥ PASTE CONFIG FIREBASE DISINI ðŸ”¥
        const firebaseConfig = {
  apiKey: "AIzaSyDQ6jBWPxaItR4LntBwdviM5BAGxhd2N7Q",
  authDomain: "vipotpsystem.firebaseapp.com",
  databaseURL: "https://vipotpsystem-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "vipotpsystem",
  storageBucket: "vipotpsystem.firebasestorage.app",
  messagingSenderId: "1041472357696",
  appId: "1:1041472357696:web:d3070f47a3c263657da6a5"
};

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- MONITOR RANGE ---
        db.ref('stock').on('value', snap => {
            const data = snap.val();
            const container = document.getElementById('rangeListContainer');
            container.innerHTML = "";

            if (!data) {
                container.innerHTML = "<div class='loading'>Stok Kosong / Database Bersih.</div>";
                return;
            }

            // Grouping Logic
            let rangeStats = {};

            Object.keys(data).forEach(key => {
                const item = data[key];
                // Fallback kalau range_name kosong
                const rName = item.range_name || "UNKNOWN/MANUAL"; 
                
                if (!rangeStats[rName]) {
                    rangeStats[rName] = { 
                        total: 0, 
                        available: 0, 
                        countryCode: item.country 
                    };
                }
                
                rangeStats[rName].total++;
                if (item.status === 'AVAILABLE') rangeStats[rName].available++;
            });

            // Render UI
            Object.keys(rangeStats).forEach(rName => {
                const stat = rangeStats[rName];
                const div = document.createElement('div');
                div.className = 'range-item';
                
                // Indikator Warna (Merah kalau habis)
                const statusColor = stat.available > 0 ? '#00ff88' : '#555';
                div.style.borderLeftColor = statusColor;

                div.innerHTML = `
                    <div class="range-info">
                        <span class="range-name">${rName}</span>
                        <span class="range-country">Code: ${stat.countryCode}</span>
                        <div style="margin-top:5px; color:#888;">
                            Sisa: <b style="color:${statusColor}">${stat.available}</b> / Total: ${stat.total}
                        </div>
                    </div>
                    <button class="btn-del" onclick="deleteRange('${rName}')">HAPUS RANGE</button>
                `;
                container.appendChild(div);
            });
        });

        // --- FUNGSI HAPUS (FIXED) ---
        window.deleteRange = (rangeName) => {
            if(confirm(`YAKIN HAPUS RANGE: "${rangeName}"?\nSemua nomor di range ini akan dihapus permanen.`)) {
                
                // Ambil snapshot dulu biar aman
                db.ref('stock').once('value', snap => {
                    const data = snap.val();
                    let updates = {};
                    let count = 0;

                    if(data) {
                        Object.keys(data).forEach(key => {
                            // Cek apakah range_name cocok (atau undefined jika menghapus UNKNOWN)
                            const currentRange = data[key].range_name || "UNKNOWN/MANUAL";
                            
                            if(currentRange === rangeName) {
                                updates[key] = null; // Tandai hapus
                                count++;
                            }
                        });
                        
                        // Eksekusi Hapus Massal
                        if(count > 0) {
                            db.ref('stock').update(updates)
                                .then(() => alert(`Berhasil menghapus ${count} nomor dari range ${rangeName}`))
                                .catch(e => alert("Gagal hapus: " + e.message));
                        } else {
                            alert("Data tidak ditemukan atau sudah terhapus.");
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
