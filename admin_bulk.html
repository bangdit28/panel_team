<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER ADMIN V124 (SYSTEM)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .box { width: 100%; max-width: 800px; border: 1px solid #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; background: #111; }
        h2 { margin-top: 0; color: #00ff88; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tabs-header { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 8px; cursor: pointer; flex: 1; font-weight: bold; font-size: 11px; min-width: 80px; }
        .tab-btn.active { background: #00ff88; color: #000; border-color: #00ff88; }
        .tab-btn.money-tab.active { background: #f43f5e; color: #fff; border-color: #f43f5e; }
        .tab-btn.sys-tab.active { background: #eab308; color: #000; border-color: #eab308; }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .list-container { max-height: 400px; overflow-y: auto; padding-right: 5px; border: 1px solid #222; background: #0a0a0a; margin-top: 10px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 10px; margin-bottom: 5px; border-radius: 5px; border-left: 3px solid #555; }
        .wd-card { border-left: 3px solid #f43f5e !important; background: #1f1212 !important; }
        .wd-info { display: flex; flex-direction: column; gap: 2px; font-size: 12px; }
        
        input, select { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #555; box-sizing: border-box; margin-bottom: 5px; }
        button.action-btn { border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-size: 10px; font-weight: bold; color: #fff; }
        .bg-red { background: #d32f2f; } .bg-green { background: #00e676; color:#000; } .bg-blue { background: #2979ff; }
        
        /* SYSTEM TAB */
        .sys-group { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .sys-label { font-size: 11px; color: #aaa; display: block; margin-bottom: 5px; }
        .switch-btn { padding: 10px; width: 100%; border: none; font-weight: bold; cursor: pointer; }
        .sw-on { background: #00e676; color: #000; } .sw-off { background: #d32f2f; color: #fff; }
    </style>
</head>
<body>

    <div class="box">
        <h2>‚ö° V124 ADMIN (SYSTEM CONTROL)</h2>

        <div class="tabs-header">
            <button class="tab-btn active" onclick="switchTab('dash')">üìä DASHBOARD</button>
            <button class="tab-btn money-tab" onclick="switchTab('money')">üí∞ KEUANGAN</button>
            <button class="tab-btn sys-tab" onclick="switchTab('system')">‚öôÔ∏è SYSTEM</button>
            <button class="tab-btn" onclick="switchTab('recycle')">‚ôªÔ∏è RECYCLE</button>
            <button class="tab-btn" onclick="switchTab('country')">üåç NEGARA</button>
            <button class="tab-btn" onclick="switchTab('upload')">üõ†Ô∏è TOOLS</button>
        </div>

        <!-- DASHBOARD -->
        <div id="dash" class="tab-content active">
            <!-- Stats -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center; margin-bottom:15px;">
                <div style="background:#1a1a1a; padding:10px; border:1px solid #444;">Available: <span id="cAvail" style="color:#00ff88">0</span></div>
                <div style="background:#1a1a1a; padding:10px; border:1px solid #444;">Active: <span id="cActive" style="color:#2979ff">0</span></div>
            </div>
            <button onclick="clearZombies()" class="action-btn bg-blue" style="width:100%; padding:15px;">üßπ LEPASKAN NOMOR STUCK ( > 2 MENIT)</button>
        </div>

        <!-- ‚öôÔ∏è SYSTEM SETTINGS (NEW) -->
        <div id="system" class="tab-content">
            <!-- REWARD CONFIG -->
            <div class="sys-group">
                <div class="sys-label">ATUR NOMINAL HADIAH (PER OTP):</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <span class="sys-label">MIN (Rp)</span>
                        <input type="number" id="rewMin" value="20">
                    </div>
                    <div style="flex:1;">
                        <span class="sys-label">MAX (Rp)</span>
                        <input type="number" id="rewMax" value="50">
                    </div>
                </div>
                <button onclick="saveRewardConfig()" class="action-btn bg-green" style="width:100%; margin-top:5px;">SIMPAN HARGA</button>
            </div>

            <!-- WALLET STATUS -->
            <div class="sys-group">
                <div class="sys-label">STATUS FITUR WALLET & WITHDRAW:</div>
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <button onclick="setWalletStatus('ON')" class="switch-btn sw-on">BUKA (ON)</button>
                    <button onclick="setWalletStatus('OFF')" class="switch-btn sw-off">TUTUP (MAINTENANCE)</button>
                </div>
                <div style="margin-top:5px; font-size:10px; text-align:center;" id="walletStatusText">Status Saat Ini: ...</div>
            </div>
        </div>

        <!-- KEUANGAN -->
        <div id="money" class="tab-content">
            <div class="list-container" id="wdListContainer">Loading...</div>
        </div>

        <!-- RECYCLE -->
        <div id="recycle" class="tab-content">
            <div style="margin-bottom:10px;"><button onclick="restoreAllRecycle()" class="action-btn bg-green">RESTORE ALL</button> <button onclick="flushRecycle()" class="action-btn bg-red">HAPUS ALL</button></div>
            <div class="list-container" id="recycleListContainer"></div>
        </div>

        <!-- COUNTRY -->
        <div id="country" class="tab-content">
            <div style="display:flex; gap:5px;"><input id="cCode" placeholder="ID"><input id="cName" placeholder="INDONESIA"><button onclick="saveCountry()" class="action-btn bg-green">SAVE</button></div>
            <button onclick="clearAllCountries()" class="action-btn bg-red" style="margin-top:5px;">RESET NEGARA</button>
            <div class="list-container" id="countryListDisplay"></div>
        </div>

        <!-- TOOLS -->
        <div id="upload" class="tab-content">
            <select id="countrySelectUpload"></select>
            <textarea id="numList" placeholder="Paste nomor..." style="height:80px;"></textarea>
            <button onclick="uploadStockSafe()" class="action-btn bg-green" style="width:100%;">UPLOAD</button>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="clearTrash()" class="action-btn bg-red" style="flex:1;">CLEAR HISTORY</button>
                <button onclick="clearAll()" class="action-btn bg-red" style="flex:1;">RESET ALL</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDQ6jBWPxaItR4LntBwdviM5BAGxhd2N7Q",
            authDomain: "vipotpsystem.firebaseapp.com",
            databaseURL: "https://vipotpsystem-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "vipotpsystem",
            storageBucket: "vipotpsystem.firebasestorage.app",
            messagingSenderId: "1041472357696",
            appId: "1:1041472357696:web:d3070f47a3c263657da6a5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- SYSTEM CONFIG ---
        // Load settings saat ini
        db.ref('settings/config').on('value', snap => {
            const conf = snap.val() || { reward_min: 20, reward_max: 50, wallet_status: 'ON' };
            document.getElementById('rewMin').value = conf.reward_min;
            document.getElementById('rewMax').value = conf.reward_max;
            document.getElementById('walletStatusText').innerText = "Status Saat Ini: " + conf.wallet_status;
            document.getElementById('walletStatusText').style.color = conf.wallet_status === 'ON' ? '#00e676' : '#d32f2f';
        });

        window.saveRewardConfig = () => {
            const min = parseInt(document.getElementById('rewMin').value);
            const max = parseInt(document.getElementById('rewMax').value);
            db.ref('settings/config').update({ reward_min: min, reward_max: max }, (e) => {
                if(!e) alert("Harga Reward Diupdate!");
            });
        }

        window.setWalletStatus = (status) => {
            if(confirm("Ubah status Wallet jadi " + status + "?")) {
                db.ref('settings/config').update({ wallet_status: status });
            }
        }

        // --- DASHBOARD ---
        let lastUpdate = 0;
        db.ref('stock').on('value', snap => {
            if (Date.now() - lastUpdate > 1000) { renderDashboard(snap.val()); lastUpdate = Date.now(); }
        });

        function renderDashboard(data) {
            let avail=0, active=0, recycle=0;
            let recHTML = "";
            if(data) Object.keys(data).forEach(k => {
                const i = data[k];
                if(i.status==='AVAILABLE') avail++;
                else if(i.status==='TAKEN') active++;
                else if(i.status==='RECYCLE' || i.status==='BAD') {
                    recycle++;
                    recHTML += `<div class="list-item" style="border-left-color:#ff9800"><div class="item-info"><span style="color:#ff9800">${i.country}</span> ${i.number}<br><span style="color:#666;font-size:10px">${i.op_name||'-'}</span></div><div><button class="action-btn bg-green" onclick="restoreOne('${k}')">R</button> <button class="action-btn" onclick="navigator.clipboard.writeText('${i.number}')">C</button></div></div>`;
                }
            });
            document.getElementById('cAvail').innerText=avail; document.getElementById('cActive').innerText=active;
            document.getElementById('recycleListContainer').innerHTML=recHTML || "Kosong";
        }

        // --- WD LIST ---
        db.ref('withdrawals').on('value', snap => {
            const d = snap.val(); const c = document.getElementById('wdListContainer'); c.innerHTML="";
            if(d) {
                Object.keys(d).forEach(k => {
                    const i = d[k];
                    if(i.status === 'PENDING') {
                        const date = new Date(i.time).toLocaleString();
                        c.innerHTML += `<div class="list-item wd-card"><div class="wd-info"><span style="color:#f43f5e;font-weight:bold;">${i.user}</span><span>Rp ${i.amount} -> ${i.dana}</span><span style="color:#666;font-size:10px;">${date}</span></div><div><button class="action-btn bg-green" onclick="accWD('${k}')">ACC</button> <button class="action-btn bg-red" onclick="decWD('${k}','${i.user}',${i.amount})">TOLAK</button></div></div>`;
                    }
                });
            }
            if(c.innerHTML==="") c.innerHTML="<div style='text-align:center;padding:10px;'>Tidak ada request.</div>";
        });
        window.accWD = (k) => { if(confirm("ACC?")) db.ref('withdrawals/'+k).update({status:'SUCCESS'}); }
        window.decWD = (k,u,a) => { if(confirm("Tolak & Refund?")) { db.ref('withdrawals/'+k).update({status:'REJECTED'}); db.ref('users/'+u+'/balance').once('value',s=>db.ref('users/'+u).update({balance:(s.val()||0)+a})); } }

        // --- OTHERS ---
        db.ref('settings/countries').on('value', s => {
            const d=s.val(); const l=document.getElementById('countryListDisplay'); const u=document.getElementById('countrySelectUpload');
            l.innerHTML=""; u.innerHTML="";
            if(d) Object.keys(d).forEach(k => {
                l.innerHTML+=`<div class="list-item"><span>${d[k]}</span><button class="action-btn bg-red" onclick="delCountry('${k}')">X</button></div>`;
                const o=document.createElement('option'); o.value=k; o.innerText=d[k]; u.appendChild(o);
            });
        });
        window.saveCountry=()=>{const c=document.getElementById('cCode').value; const n=document.getElementById('cName').value; if(c&&n)db.ref('settings/countries/'+c).set(n);}
        window.delCountry=(k)=>{if(confirm("Del?"))db.ref('settings/countries/'+k).remove();}
        window.clearAllCountries=()=>{if(confirm("Reset Negara?"))db.ref('settings/countries').remove();}
        
        window.uploadStockSafe=()=>{
            const raw=document.getElementById('numList').value; const c=document.getElementById('countrySelectUpload').value;
            if(!c)return alert("Pilih Negara!");
            const lines=raw.split(/\n/); const ts=Date.now();
            db.ref('stock').once('value', snap=>{
                const ex=snap.val()||{}; let u={};
                lines.forEach(l=>{ let n=l.replace(/\D/g,''); if(n.length>6 && !ex[n]) u[n]={number:n, country:c, status:'AVAILABLE', range_name:"MANUAL", timestamp:ts, otp:""}; });
                db.ref('stock').update(u, e=>{ if(!e) {alert("Done"); document.getElementById('numList').value="";} });
            });
        }

        window.switchTab=(id)=>{ document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }
        window.restoreOne=(k)=>db.ref('stock/'+k).update({status:'AVAILABLE',owner:null,op_name:null,otp:null});
        window.restoreAllRecycle=()=>{ if(confirm("All?")) db.ref('stock').once('value',s=>{ const d=s.val(); let u={}; Object.keys(d).forEach(k=>{ if(d[k].status==='RECYCLE'||d[k].status==='BAD') u[k+'/status']='AVAILABLE'; }); db.ref('stock').update(u); }); }
        window.flushRecycle=()=>{ if(confirm("Flush?")) db.ref('stock').once('value',s=>{ const d=s.val(); let u={}; Object.keys(d).forEach(k=>{ if(d[k].status==='RECYCLE'||d[k].status==='BAD') u[k]=null; }); db.ref('stock').update(u); }); }
        window.clearZombies=()=>{ db.ref('stock').once('value',s=>{ const d=s.val(); let u={}; const now=Date.now(); Object.keys(d).forEach(k=>{ if(d[k].status==='TAKEN' && (now-(d[k].timestamp||0)>120000)) { u[k+'/status']='RECYCLE'; u[k+'/op_name']='(Timeout)'; } }); db.ref('stock').update(u); }); }
        window.clearTrash=()=>{ if(confirm("Clean History?")) db.ref('stock').once('value',s=>{ const d=s.val(); let u={}; Object.keys(d).forEach(k=>{ if(d[k].status==='DONE') u[k]=null; }); db.ref('stock').update(u); }); }
        window.clearAll=()=>{ if(confirm("RESET ALL?")) db.ref('stock').remove(); }
    </script>
</body>
</html>
